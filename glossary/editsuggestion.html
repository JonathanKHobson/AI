<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Glossary Term — AI Prompting Glossary</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --card:#0f151d; --muted:#9db0c3; --text:#e7eff7;
      --accent:#4ea1ff; --chip:#1b2533; --border:#1b2838;
      --green:#2ecc71; --yellow:#f1c40f; --red:#e74c3c;
      --header-h:64px; --radius:12px; --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:linear-gradient(180deg,#0b0f14,#0a0d12);
      font:16px/1.42 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .app{display:grid;grid-template-rows:var(--header-h) 1fr;height:100%}
    header{
      display:flex;align-items:center;gap:12px;
      padding:0 16px;background:rgba(18,24,33,.8);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:5;
    }
    header h1{font-size:18px;margin:0 4px 0 0;font-weight:600;letter-spacing:.2px}
    .spacer{flex:1}
    main{max-width:980px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
    .row{display:grid;grid-template-columns:200px 1fr;gap:12px;align-items:start;margin:10px 0}
    .row label{color:var(--muted);padding-top:10px}
    input[type="text"], input[type="url"], textarea, select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:var(--text);outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:12px}
    .chip button{background:none;border:none;color:var(--muted);cursor:pointer}
    .btn{border:1px solid var(--border);background:var(--chip);padding:9px 12px;border-radius:10px;color:var(--text);cursor:pointer}
    .btn.primary{background:#18324a;border-color:#264b6b}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:12px}
    .pill.good{color:var(--green)}
    .pill.bad{color:var(--yellow)}
    .section-title{font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin:18px 0 8px}
    .stack{display:grid;gap:10px}
    .list{display:grid;gap:10px}
    .subgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--muted)}
    /* Modal + better contrast for any suggestion chips if we add later */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:1000;}
    .modal{ width:min(680px,90vw); background:#0d131b; color:#e7eff7; border:1px solid #1b2838; border-radius:12px; padding:18px; box-shadow:0 20px 70px rgba(0,0,0,.35); }
    .modal h3{ margin:0 0 6px 0; font-size:18px }
    .modal p{ margin:0 0 12px 0; color:#9db0c3 }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end }
    .modal .btn{ padding:8px 12px; border-radius:10px; border:1px solid #1b2838; background:#1b2533; color:#e7eff7; cursor:pointer }
    .modal .btn.primary{ background:#4ea1ff; border-color:#4ea1ff; color:#061422 }
    .toast{position:fixed; right:16px; bottom:16px; background:#0c1117; border:1px solid var(--border); border-radius:10px; padding:10px 12px; color:var(--text)}
    pre{white-space:pre-wrap;word-break:break-word;margin:0}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Edit Glossary Term</h1>
    <span class="spacer"></span>
    <a class="btn" href="./index.html">← Back to index</a>
  </header>
  <main>
    <div class="card">
      <div class="row">
        <label>Original term</label>
        <div class="inline">
          <span id="origTerm" class="pill"></span>
          <span id="origSlug" class="pill muted"></span>
          <span id="dupFlag" class="pill"></span>
        </div>
      </div>

      <div class="row">
        <label for="term">Term</label>
        <input id="term" type="text" placeholder="e.g., Prompt Architecture" />
      </div>
      <div class="row">
        <label for="aliases">Aliases</label>
        <input id="aliases" type="text" placeholder="Comma-separated (e.g., Virtual Brain, VB)" />
      </div>
      <div class="row">
        <label for="definition">Definition</label>
        <textarea id="definition" placeholder="Write a clear, concise definition…"></textarea>
      </div>
      <div class="row">
        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Optional reviewer notes or rationale…"></textarea>
      </div>

      <div class="section-title">Classification</div>
      <div class="row">
        <label>Categories</label>
        <div>
          <div id="catChips" class="chips"></div>
          <div class="inline" style="margin-top:8px">
            <select id="catSelect"></select>
            <button id="addCat" class="btn">Add</button>
            <input id="catNew" type="text" placeholder="or create new category…" style="max-width:300px" />
            <button id="addCatNew" class="btn">Create</button>
          </div>
          <div class="hint">Click a chip’s × to remove.</div>
        </div>
      </div>

      <div class="row">
        <label>Tags</label>
        <div>
          <div id="tagChips" class="chips"></div>
          <div class="inline" style="margin-top:8px">
            <input id="tagInput" list="tagList" type="text" placeholder="Add a tag then press Enter, e.g., topic:prompting" style="min-width:320px" />
            <datalist id="tagList"></datalist>
            <button id="addTagBtn" class="btn">Add</button>
          </div>
          <div class="hint">Tags are free-form, but common prefixes include <code>topic:</code>, <code>type:</code>, <code>phase:</code>.</div>
        </div>
      </div>

      <div class="section-title">Relationships & Sources</div>
      <div class="row">
        <label>Related slugs</label>
        <div>
          <div id="relChips" class="chips"></div>
          <div class="inline" style="margin-top:8px">
            <input id="relInput" list="relList" type="text" placeholder="Start typing a slug…" style="min-width:320px" />
            <datalist id="relList"></datalist>
            <button id="addRelBtn" class="btn">Add</button>
          </div>
          <div class="hint">Use slugs (e.g., <code>prompt-architecture</code>). Click chip × to remove.</div>
        </div>
      </div>

      <div class="row">
        <label>Sources</label>
        <div class="list" id="srcList"></div>
      </div>
      <div class="row">
        <label></label>
        <button id="addSource" class="btn">+ Add source</button>
      </div>

      <div class="section-title">Justification / Message</div>
      <div class="row">
        <label for="message">Message to maintainer</label>
        <textarea id="message" placeholder="Why is this edit needed? What’s improved or fixed? Provide context, links, etc."></textarea>
      </div>

      <div class="section-title">Submit</div>
      <div class="row">
        <label>Suggestion type</label>
        <div class="inline">
          <span id="suggestType" class="pill">edit</span>
          <span id="statusHint" class="pill bad">draft</span>
          <span class="muted">Your edit will be emailed to the maintainer.</span>
        </div>
      </div>
      <div class="row">
        <label></label>
        <div class="inline">
          <button id="sendBtn" class="btn primary">Email edit to maintainer</button>
          <button id="previewBtn" class="btn">Preview Snippet</button>
          <button id="resetBtn" class="btn">Reset changes</button>
        </div>
      </div>

      <div id="preview" class="card" style="margin-top:14px; display:none">
        <div class="section-title">Preview Snippet</div>
        <pre id="json"></pre>
      </div>
    </div>
  </main>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="successTitle">
  <div class="modal">
    <h3 id="successTitle">Submission sent ✉️</h3>
    <p id="successText">Thanks! Your edit suggestion was emailed to the maintainer.</p>
    <div class="actions">
      <button class="btn" id="successStay">Stay on page</button>
      <a class="btn primary" href="./index.html">Back to Glossary</a>
    </div>
  </div>
</div>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function(){
    // Public key
    emailjs.init("DpN9hLocoU__4dYVX");
    // Service + template
    window.EMAILJS = {
      service: "service_9wx16fe",
      template: "template_hjbmxbn"
    };
  })();
</script>

<!-- Glossary data for prefill/suggestions -->
<script src="./js/glossary.data.js"></script>

<script>
(function(){
  const MAINTAINER = "JonathanKyleHobson@gmail.com";

  // Load glossary
  const G = (globalThis.GLOSSARY && Array.isArray(GLOSSARY)) ? GLOSSARY : (globalThis.GlossaryAPI?.all?.() ?? []);
  const bySlug = new Map(G.map(x => [x.slug, x]));
  const norm = s => (s||'').toString().trim().toLowerCase();

  // Resolve slug
  const params = new URLSearchParams(location.search);
  const slug = params.get('slug') || '';
  const item = bySlug.get(slug);
  if(!item){
    alert('No term found for slug: ' + slug + '\nYou will be redirected to the index.');
    location.href = './index.html';
    return;
  }

  // Suggestion stores
  const allCats = new Set();
  const allTags = new Set();
  const allSlugs = new Set();
  for(const t of G){
    for(const c of (t.categories||[])) allCats.add(c);
    for(const tg of (t.tags||[])) allTags.add(tg);
    allSlugs.add(t.slug);
  }

  // DOM
  const $ = sel => document.querySelector(sel);
  const catChips = $('#catChips');
  const tagChips = $('#tagChips');
  const relChips = $('#relChips');
  const catSelect = $('#catSelect');
  const catNew = $('#catNew');
  const tagInput = $('#tagInput');
  const relInput = $('#relInput');
  const tagList = $('#tagList');
  const relList = $('#relList');
  const srcList = $('#srcList');
  const dupFlag = $('#dupFlag');
  const statusHint = $('#statusHint');

  // Header/prefill
  $('#origTerm').textContent = item.term;
  $('#origSlug').textContent = item.slug;

  $('#term').value = item.term || '';
  $('#aliases').value = (item.aliases||[]).join(', ');
  $('#definition').value = item.definition || '';
  $('#notes').value = item.notes || '';

  const state = {
    categories: new Set(item.categories||[]),
    tags: new Set(item.tags||[]),
    related: new Set(item.related||[]),
    sources: (item.sources||[]).map(s => ({ title: s.title || '', url: s.url || '' })),
    suggested_status: 'draft'
  };

  function renderSelectOptions(select, values){
    select.innerHTML = '';
    [...values].sort((a,b)=>a.localeCompare(b)).forEach(v => {
      const opt = document.createElement('option');
      opt.value = v; opt.textContent = v;
      select.appendChild(opt);
    });
  }
  renderSelectOptions(catSelect, allCats);
  tagList.innerHTML = [...allTags].sort((a,b)=>a.localeCompare(b)).map(t => '<option value="'+t+'"></option>').join('');
  relList.innerHTML = [...allSlugs].sort((a,b)=>a.localeCompare(b)).map(s => '<option value="'+s+'"></option>').join('');

  function chip(container, label, onRemove){
    const el = document.createElement('span');
    el.className = 'chip';
    el.innerHTML = '<span>'+label+'</span> <button title="Remove">×</button>';
    el.querySelector('button').addEventListener('click', onRemove);
    container.appendChild(el);
  }

  function renderCatChips(){
    catChips.innerHTML = '';
    state.categories.forEach(c => chip(catChips, c, () => { state.categories.delete(c); renderCatChips(); }));
  }
  function renderTagChips(){
    tagChips.innerHTML = '';
    state.tags.forEach(t => chip(tagChips, t, () => { state.tags.delete(t); renderTagChips(); }));
  }
  function renderRelChips(){
    relChips.innerHTML = '';
    state.related.forEach(r => chip(relChips, r, () => { state.related.delete(r); renderRelChips(); }));
  }
  function renderSources(){
    srcList.innerHTML = '';
    state.sources.forEach((s, i) => {
      const row = document.createElement('div');
      row.className = 'subgrid';
      row.innerHTML = `
        <input data-ix="${i}" class="src-title" type="text" placeholder="Source title" value="${(s.title||'').replaceAll('"','&quot;')}">
        <input data-ix="${i}" class="src-url" type="url" placeholder="https://example.com" value="${(s.url||'').replaceAll('"','&quot;')}">
      `;
      srcList.appendChild(row);
    });
  }
  renderCatChips(); renderTagChips(); renderRelChips(); renderSources();

  // Handlers
  $('#addCat').addEventListener('click', () => {
    const v = catSelect.value.trim(); if(!v) return;
    state.categories.add(v); renderCatChips();
  });
  $('#addCatNew').addEventListener('click', () => {
    const v = catNew.value.trim(); if(!v) return;
    allCats.add(v); state.categories.add(v); catNew.value=''; renderCatChips(); renderSelectOptions(catSelect, allCats);
  });

  function addTagFromInput(){ const v = tagInput.value.trim(); if(!v) return; state.tags.add(v); tagInput.value=''; renderTagChips(); }
  $('#addTagBtn').addEventListener('click', addTagFromInput);
  tagInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addTagFromInput(); } });

  function addRelFromInput(){
    const v = relInput.value.trim(); if(!v) return;
    if(!allSlugs.has(v)){ if(!confirm('Slug not found in glossary. Add anyway?')) return; }
    state.related.add(v); relInput.value=''; renderRelChips();
  }
  $('#addRelBtn').addEventListener('click', addRelFromInput);
  relInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addRelFromInput(); } });

  $('#addSource').addEventListener('click', () => { state.sources.push({ title:'', url:'' }); renderSources(); });
  srcList.addEventListener('input', (e)=>{
    const t = e.target; const ix = +t.dataset.ix;
    if(t.classList.contains('src-title')) state.sources[ix].title = t.value;
    if(t.classList.contains('src-url')) state.sources[ix].url = t.value;
  });

  // Duplicate candidate detection (by term title collision)
  function checkDuplicateCandidate(){
    const newTerm = norm($('#term').value);
    let dupOf = null;
    if(newTerm){
      for(const t of G){
        if(t.slug !== item.slug && norm(t.term) === newTerm){ dupOf = t.slug; break; }
      }
    }
    if(dupOf){
      state.suggested_status = 'duplicate_candidate';
      dupFlag.textContent = 'Possible duplicate of ' + dupOf;
      dupFlag.className = 'pill bad';
      statusHint.textContent = 'duplicate_candidate';
      statusHint.className = 'pill bad';
    } else {
      state.suggested_status = 'draft';
      dupFlag.textContent = 'No duplicate detected';
      dupFlag.className = 'pill good';
      statusHint.textContent = 'draft';
      statusHint.className = 'pill bad';
    }
  }
  checkDuplicateCandidate();
  $('#term').addEventListener('input', checkDuplicateCandidate);

  // Helpers
  const slugify = s => (s||'').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9]+/g,'-').replace(/(^-|-$)/g,'').toLowerCase();
  function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3500); }
  function showSuccessModal(){ const m = document.getElementById('successModal'); m.style.display='flex'; document.getElementById('successStay').onclick=()=>{m.style.display='none'}; }

  // Build proposed object + merged final object
  function currentInputs(){
    return {
      term: $('#term').value.trim(),
      aliases: $('#aliases').value.split(',').map(s=>s.trim()).filter(Boolean),
      definition: $('#definition').value.trim(),
      notes: $('#notes').value.trim(),
      categories: [...state.categories],
      tags: [...state.tags],
      related: [...state.related],
      sources: state.sources.filter(s => s.title || s.url)
    };
  }
  function buildProposedDiff(){
    const cur = currentInputs();
    const proposed = {};
    function diff(key, val){
      const orig = item[key] || (Array.isArray(val)? [] : '');
      const equal = Array.isArray(val)
        ? JSON.stringify([...val].sort()) === JSON.stringify([...(orig||[])].sort())
        : (val === orig);
      if(!equal) proposed[key] = val;
    }
    Object.entries(cur).forEach(([k,v])=>diff(k,v));
    return proposed;
  }
  function mergeFinal(proposed){
    return {
      slug: slugify(proposed.term || item.term),
      term: proposed.term ?? item.term,
      aliases: proposed.aliases ?? (item.aliases||[]),
      definition: proposed.definition ?? item.definition,
      sources: proposed.sources ?? (item.sources||[]),
      categories: proposed.categories ?? (item.categories||[]),
      tags: proposed.tags ?? (item.tags||[]),
      related: proposed.related ?? (item.related||[]),
      status: state.suggested_status, // editor suggestions enter as draft/duplicate_candidate
      notes: proposed.notes ?? (item.notes || '')
    };
  }
  // JS-style block formatter (like add page)
  function jsBlock(obj){
    const esc = s => (s||"").replace(/\\/g,"\\\\").replace(/"/g,'\\"');
    const escBT = s => (s||"").replace(/`/g,"\\`");
    const arr = xs => xs.map(x=>`"${esc(x)}"`).join(", ");
    const srcs = (obj.sources||[]).map(s=>`{ title: "${esc(s.title||"")}", url: "${esc(s.url||"")}" }`).join(", ");
    return ` {
    slug: "${esc(obj.slug)}",
    term: "${esc(obj.term)}",
    aliases: [${arr(obj.aliases||[])}],
    definition: \`${escBT(obj.definition)}\`,
    sources: [${srcs}],
    categories: [${arr(obj.categories||[])}],
    tags: [${arr(obj.tags||[])}],
    related: [${arr(obj.related||[])}],
    status: "${esc(obj.status)}",
    notes: "${esc(obj.notes||"")}"
  }`;
  }
  function changedFieldsBlock(proposed){
    if(!proposed || Object.keys(proposed).length===0) return "(no field changes detected)";
    const esc = s => (s||"").replace(/\\/g,"\\\\").replace(/"/g,'\\"');
    const escBT = s => (s||"").replace(/`/g,"\\`");
    const arr = xs => `[${xs.map(x=>`"${esc(x)}"`).join(", ")}]`;
    const lines = [];
    for(const [k,v] of Object.entries(proposed)){
      if(k==='definition'){ lines.push(`${k}: \`${escBT(v)}\``); }
      else if(Array.isArray(v)){ lines.push(`${k}: ${arr(v)}`); }
      else { lines.push(`${k}: "${esc(v)}"`); }
    }
    return lines.join("\n");
  }

  // Preview
  document.getElementById('previewBtn').addEventListener('click', ()=>{
    const proposed = buildProposedDiff();
    const merged = mergeFinal(proposed);
    const body =
`Changed fields:
${changedFieldsBlock(proposed)}

Paste into glossary.data.js (replace entry with slug "${item.slug}"):

${jsBlock(merged)}
`;
    document.getElementById('json').textContent = body;
    document.getElementById('preview').style.display = 'block';
  });

  // Submit (EmailJS → fallback mailto)
  document.getElementById('sendBtn').addEventListener('click', async ()=>{
    const proposed = buildProposedDiff();
    const merged = mergeFinal(proposed);

    const maintMsg = (document.getElementById('message').value || '').trim() || "(none provided)";
    const body =
`Message to maintainer:
${maintMsg}

Changed fields:
${changedFieldsBlock(proposed)}

Paste into glossary.data.js (replace entry with slug "${item.slug}"):

${jsBlock(merged)}
`;

    const subjPrefix = (state.suggested_status === 'duplicate_candidate') ? "[possible duplicate] " : "";
    const title = "Term Edit Suggestion";
    const name = merged.term;

    if(window.emailjs && window.EMAILJS){
      try{
        document.getElementById('sendBtn').disabled = true;
        await emailjs.send(window.EMAILJS.service, window.EMAILJS.template, { title, name, message: body });
        showSuccessModal();
        return;
      }catch(err){
        console.error(err);
        toast("Email service failed; falling back to your mail app…");
      }finally{
        document.getElementById('sendBtn').disabled = false;
      }
    }

    // mailto fallback
    const subject = `${subjPrefix}${title}: ${merged.term}`;
    const mailto = `mailto:${encodeURIComponent(MAINTAINER)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailto;
  });

  // Reset
  document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Reset changes to original values?')) location.reload(); });

})();</script>
</body>
</html>
